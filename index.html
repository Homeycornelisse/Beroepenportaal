<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Kansrijke Beroepen Portaal 2025-2026</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['DM Sans', 'sans-serif'], mono: ['DM Mono', 'monospace'] },
          colors: {
            uwv: { blue: '#003082', mid: '#0055b3', light: '#e8f0fb', orange: '#e85d00', bg: '#f4f6fb' }
          }
        }
      }
    };
  </script>

  <style>
    :root {
      --blue: #003082;
      --mid: #0055b3;
      --orange: #e85d00;
      --bg: #f4f6fb;
    }

    body { font-family: 'DM Sans', sans-serif; }

    textarea { resize: none; min-height: 72px; }
    textarea:focus { outline: none; border-color: var(--orange); box-shadow: 0 0 0 2px rgba(232,93,0,.15); }

    .card { transition: box-shadow .15s, transform .15s; }
    .card:hover { box-shadow: 0 8px 24px rgba(0,48,130,.1); transform: translateY(-1px); }

    .lvl-basis    { background: #fef3c7; color: #92400e; }
    .lvl-mid      { background: #dcfce7; color: #166534; }
    .lvl-hoger    { background: #dbeafe; color: #1e40af; }

    /* Dynamisch gezet via JS */
    @media print {
      @page { size: A4 portrait; margin: 12mm; } /* fallback */
    }

    /* ===== PRINT / EXPORT ===== */
    @media print {
      .no-print { display: none !important; }
      body { background: white !important; margin: 0; padding: 0; }
      #portalView, #settingsView { display: none !important; }
      #exportView { display: block !important; }

      .export-banner {
        background: linear-gradient(135deg, #003082 0%, #0055b3 100%) !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        color: white !important;
      }

      .export-sector-header {
        background: #e8f0fb !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .export-lvl-badge {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .export-card {
        border: 1px solid #e2e8f0 !important;
        break-inside: avoid;
      }
    }

    .export-banner {
      background: linear-gradient(135deg, #003082 0%, #0055b3 100%);
      padding: 32px 40px;
      color: white;
      border-radius: 0 0 16px 16px;
    }
  </style>

  <!-- Hier zet JS straks @page size in -->
  <style id="printPageStyle"></style>
</head>

<body class="bg-uwv-bg text-slate-900" style="min-height:100vh;">

  <!-- ===== NAV ===== -->
  <nav class="bg-white sticky top-0 z-50 border-b border-slate-200 no-print shadow-sm">
    <div class="max-w-7xl mx-auto px-5 py-3 flex flex-wrap gap-3 justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="rounded-lg p-1.5" style="background:var(--blue);">
          <svg width="26" height="26" viewBox="0 0 26 26" fill="none">
            <rect width="26" height="26" rx="6" fill="#003082"/>
            <text x="5" y="19" font-size="14" font-weight="700" fill="white" font-family="DM Sans">BP</text>
          </svg>
        </div>
        <div>
          <div class="font-bold text-base leading-tight" style="color:var(--blue)">Kansrijke Beroepen Portaal</div>
          <div id="dataBadge" class="text-xs text-slate-400 font-mono leading-tight"></div>
        </div>
      </div>

      <div class="flex flex-wrap gap-2 items-center">
        <button id="tabPortalBtn"   onclick="showPortal()"   class="px-3 py-1.5 rounded-lg text-sm font-semibold transition-all">Portaal</button>
        <button id="tabSettingsBtn" onclick="showSettings()" class="px-3 py-1.5 rounded-lg text-sm font-semibold transition-all">Instellingen</button>

        <input type="text" id="searchInput" placeholder="Zoek beroep of sector…"
               class="p-2 border border-slate-200 rounded-lg text-sm w-56 focus:border-blue-400 focus:ring-1 focus:ring-blue-100 outline-none">

        <!-- Export instellingen -->
        <select id="printOrientation" class="p-2 border border-slate-200 rounded-lg text-sm bg-white outline-none">
          <option value="portrait">Portret</option>
          <option value="landscape">Liggend</option>
        </select>

        <button id="exportBtn"
                class="text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:opacity-90 transition"
                style="background:var(--orange);">
          ⬇ Export mijn selectie
        </button>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-7">

    <!-- ===== PORTAAL ===== -->
    <section id="portalView">

      <!-- Banner: eerst PDF uploaden -->
<div id="pdfBanner" class="hidden no-print mb-5">
  <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4 flex flex-wrap items-center justify-between gap-3">
    <div>
      <div class="font-bold text-amber-900">Tip: upload eerst de UWV PDF</div>
      <div class="text-sm text-amber-800">
        Dan werken de “Meer info” links precies zoals in de PDF. Zonder upload gebruiken we zoeklinks.
      </div>
    </div>
    <button onclick="showSettings()"
      class="px-4 py-2 rounded-xl text-sm font-bold text-white hover:opacity-90 transition"
      style="background:var(--orange);">
      Ga naar instellingen
    </button>
  </div>
</div>

      <!-- Filters -->
      <div class="flex flex-wrap gap-3 mb-6 no-print">
        <select id="sectorFilter" class="p-2.5 bg-white border border-slate-200 rounded-xl text-sm font-medium shadow-sm outline-none focus:border-blue-400">
          <option value="all">Alle sectoren</option>
        </select>

        <select id="levelFilter" class="p-2.5 bg-white border border-slate-200 rounded-xl text-sm font-medium shadow-sm outline-none focus:border-blue-400">
          <option value="all">Alle niveaus</option>
          <option value="Basis">Basisvakmanschap</option>
          <option value="Middelbaar">Middelbaar</option>
          <option value="Hoger">Hoger</option>
        </select>

        <select id="selectedFilter" class="p-2.5 bg-white border border-slate-200 rounded-xl text-sm font-medium shadow-sm outline-none focus:border-blue-400">
          <option value="all">Alles tonen</option>
          <option value="selected">Alleen aangevinkt</option>
        </select>

        <button onclick="resetFilters()" class="px-3 py-2.5 rounded-xl bg-white border border-slate-200 text-sm font-medium hover:bg-slate-50 transition">
          Filters wissen
        </button>

        <div id="statusLine" class="text-sm text-slate-500 flex items-center font-mono"></div>
      </div>

      <div id="beroepenContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5"></div>
    </section>

    <!-- ===== INSTELLINGEN ===== -->
    <section id="settingsView" class="hidden no-print">
      <div class="bg-white rounded-2xl p-7 shadow-sm border border-slate-200 max-w-xl">
        <h2 class="text-lg font-bold mb-1" style="color:var(--blue)">Instellingen</h2>
        <p class="text-sm text-slate-500 mb-5">
          Upload de UWV PDF om de gegevens bij te werken. Dan worden ook de “Meer info” links exact zoals in de PDF.
          Zonder upload gebruiken we een zoeklink als fallback.
        </p>

        <div class="p-4 rounded-xl bg-slate-50 border border-slate-200 mb-5">
          <div class="text-sm font-semibold text-slate-700 mb-1">Officiële UWV bron</div>
          <p class="text-xs text-slate-500 mb-3">Download de nieuwste PDF met kansrijke beroepen.</p>
          <a href="https://www.uwv.nl/nl/arbeidsmarktinformatie/kansen-beroep/kansrijke-beroepen"
             target="_blank" rel="noopener"
             class="inline-block text-white px-4 py-2 rounded-lg text-sm font-bold hover:opacity-90 transition"
             style="background:var(--blue);">
            Ga naar UWV.nl
          </a>
        </div>

        <div class="mb-4">
          <label class="text-sm font-semibold text-slate-700 block mb-2">Eigen PDF uploaden</label>
          <input id="pdfFileInput" type="file" accept="application/pdf"
                 class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-white">
          <p class="text-xs text-slate-400 mt-1">Parseren kan een paar seconden duren.</p>
        </div>

        <div class="flex flex-wrap gap-3">
          <button onclick="loadDefault()" class="bg-white border border-slate-200 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-50 transition">
            Standaard 2025–2026 laden
          </button>
          <button onclick="clearUserState()" class="bg-white border border-slate-200 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-50 transition">
            Mijn notities wissen
          </button>
        </div>

        <div id="settingsMsg" class="mt-4 text-sm"></div>
      </div>
    </section>

    <!-- ===== EXPORT VIEW (print only) ===== -->
    <section id="exportView" class="hidden">

      <!-- Banner -->
      <div class="export-banner">
        <div class="flex items-start justify-between flex-wrap gap-4">
          <div>
            <div class="text-xs font-bold uppercase tracking-widest opacity-70 mb-1">Kansrijke Beroepen Portaal 2025–2026</div>
            <h1 class="text-3xl font-bold mb-1">Mijn geselecteerde beroepen</h1>
            <div id="exportSubtitle" class="text-sm opacity-80"></div>
          </div>
          <div class="text-right">
            <div class="text-xs opacity-60 mb-1">Bron: UWV</div>
            <div id="exportMeta" class="text-xs opacity-60"></div>
          </div>
        </div>
      </div>

      <!-- Export legend -->
      <div class="flex flex-wrap gap-3 mt-5 mb-6 px-1">
        <div class="flex items-center gap-2 text-xs text-slate-600">
          <span class="px-2 py-0.5 rounded font-bold export-lvl-badge lvl-basis">BASIS</span> Basisvakmanschap
        </div>
        <div class="flex items-center gap-2 text-xs text-slate-600">
          <span class="px-2 py-0.5 rounded font-bold export-lvl-badge lvl-mid">MBO</span> Middelbaar beroepsniveau
        </div>
        <div class="flex items-center gap-2 text-xs text-slate-600">
          <span class="px-2 py-0.5 rounded font-bold export-lvl-badge lvl-hoger">HBO/WO</span> Hoger / wetenschappelijk
        </div>
      </div>

      <div id="exportList" class="space-y-6"></div>

      <!-- Footer -->
      <div class="mt-8 pt-4 border-t border-slate-200 text-xs text-slate-400">
        UWV Kansrijke Beroepen 2025–2026 · uwv.nl · Gegenereerd via Beroepen Portaal
      </div>
    </section>

  </main>

  <script>
  // =====================================================================
  // INGEBOUWDE DATASET (zoals jij had; url is leeg -> fallback zoeklink)
  // =====================================================================
  const INGEBOUWDE_DATA = [
    /* --- jouw hele dataset blijft hetzelfde --- */
  ].map(b => ({...b, info:"Uit UWV-lijst kansrijke beroepen 2025-2026", url:""}));

  // LET OP: je had al een gigantische dataset in je bestand.
  // Plak die gewoon terug tussen de [ ... ] hierboven (ik laat hem hier weg om de chat niet te slopen).

  // =====================================================================
  // STATE
  // =====================================================================
  const STORAGE_KEY   = 'bp2026_data_v7';
  const STORAGE_STATE = 'bp2026_user_v7';

  let beroepen  = loadData() || INGEBOUWDE_DATA;
  let userState = loadUserState();

  function loadData() {
    try { const r = JSON.parse(localStorage.getItem(STORAGE_KEY)); return r?.beroepen || null; } catch { return null; }
  }
  function saveData(d) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ savedAt: new Date().toISOString(), beroepen: d }));
    beroepen = d;
    updateBadge();
  }
  function loadUserState() {
    try { return JSON.parse(localStorage.getItem(STORAGE_STATE)) || {}; } catch { return {}; }
  }
  function saveUserState() {
    localStorage.setItem(STORAGE_STATE, JSON.stringify(userState));
  }
  function updateBadge() {
    try {
      const r = JSON.parse(localStorage.getItem(STORAGE_KEY));
      const dt = r?.savedAt ? new Date(r.savedAt) : null;
      document.getElementById('dataBadge').textContent = dt
        ? `Bijgewerkt: ${dt.toLocaleString('nl-NL')}`
        : `Standaard 2025-2026 · ${beroepen.length} beroepen`;
    } catch { document.getElementById('dataBadge').textContent = `${beroepen.length} beroepen`; }
  }

  function getKey(b){ return `${b.s}||${b.n}`.toLowerCase(); }

  function getEntry(b) {
    const k = getKey(b);
    if (!userState[k]) userState[k] = { like: false, doelgroep: false, note: '' };
    return userState[k];
  }

  function hasUploadedPdfData() {
  try {
    const r = JSON.parse(localStorage.getItem(STORAGE_KEY));
    // Als er ooit data is opgeslagen via saveData() dan staat savedAt erin
    // Bij standaard data (alleen in code) staat dat er niet.
    return !!(r && r.savedAt && Array.isArray(r.beroepen) && r.beroepen.length);
  } catch {
    return false;
  }
}

function updatePdfBanner() {
  const banner = document.getElementById('pdfBanner');
  if (!banner) return;

  // Banner tonen als er nog GEEN geüploade data is
  if (hasUploadedPdfData()) banner.classList.add('hidden');
  else banner.classList.remove('hidden');
}

  // =====================================================================
  // TABS
  // =====================================================================
  function showPortal() {
    document.getElementById('portalView').classList.remove('hidden');
    document.getElementById('settingsView').classList.add('hidden');
    document.getElementById('tabPortalBtn').style.cssText   = 'background:var(--blue);color:white;';
    document.getElementById('tabSettingsBtn').style.cssText = 'background:white;color:#374151;border:1px solid #e5e7eb;';
  }
  function showSettings() {
    document.getElementById('settingsView').classList.remove('hidden');
    document.getElementById('portalView').classList.add('hidden');
    document.getElementById('tabSettingsBtn').style.cssText = 'background:var(--blue);color:white;';
    document.getElementById('tabPortalBtn').style.cssText   = 'background:white;color:#374151;border:1px solid #e5e7eb;';
  }

  // =====================================================================
  // FILTERS
  // =====================================================================
  document.getElementById('searchInput').addEventListener('keyup', filterContent);
  document.getElementById('levelFilter').addEventListener('change', filterContent);
  document.getElementById('sectorFilter').addEventListener('change', filterContent);
  document.getElementById('selectedFilter').addEventListener('change', filterContent);

  function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('levelFilter').value = 'all';
    document.getElementById('sectorFilter').value = 'all';
    document.getElementById('selectedFilter').value = 'all';
    filterContent();
  }

  function refreshSectorDropdown() {
    const sel = document.getElementById('sectorFilter');
    const sectors = [...new Set(beroepen.map(b => b.s))].sort((a,b) => a.localeCompare(b,'nl'));
    sel.innerHTML = '<option value="all">Alle sectoren</option>' +
      sectors.map(s => `<option value="${esc(s)}">${esc(s)}</option>`).join('');
  }

  function filterContent() {
    const q    = document.getElementById('searchInput').value.toLowerCase();
    const lvl  = document.getElementById('levelFilter').value;
    const sec  = document.getElementById('sectorFilter').value;
    const sel  = document.getElementById('selectedFilter').value === 'selected';
    render(q, lvl, sec, sel);
  }

  // =====================================================================
  // RENDER CARDS
  // =====================================================================
  function lvlBadge(lvl) {
    if ((lvl||'').includes('Hoger')) return 'lvl-hoger';
    if ((lvl||'').includes('Basis')) return 'lvl-basis';
    return 'lvl-mid';
  }
  function lvlLabel(lvl) {
    if ((lvl||'').includes('Hoger')) return 'HBO/WO';
    if ((lvl||'').includes('Basis')) return 'BASIS';
    return 'MBO';
  }

  // Fallback zoeklink (als we geen echte PDF-detail-url hebben)
  function werkNlSearchUrl(name) {
    return `https://www.werk.nl/werkzoekenden/beroepen-en-opleidingen/beroepen/zoeken?zoekterm=${encodeURIComponent(name)}`;
  }

  function esc(s) {
    return (s||'')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }

  function normalizeWerkUrl(url){
    if (!url) return '';
    // de PDF gebruikt vaak werk.nl/nl/beroepskeuze/.../details/<id>
    // die nemen we exact over
    if (/^https?:\/\/www\.werk\.nl\//i.test(url)) return url;
    return '';
  }

  function render(q='', lvl='all', sec='all', onlySel=false) {
    const container = document.getElementById('beroepenContainer');
    container.innerHTML = '';

    const filtered = beroepen.filter(b => {
      const entry = getEntry(b);
      const mQ  = !q || (b.n||'').toLowerCase().includes(q) || (b.s||'').toLowerCase().includes(q);
      const mL  = lvl === 'all' || (b.lvl||'').includes(lvl);
      const mS  = sec === 'all' || b.s === sec;
      const mSel = !onlySel || entry.like;
      return mQ && mL && mS && mSel;
    });

    document.getElementById('statusLine').textContent = `${filtered.length} van ${beroepen.length} beroepen`;

    filtered.forEach(b => {
      const entry  = getEntry(b);
      const k      = getKey(b);
      const pdfUrl = normalizeWerkUrl(b.url);
      const infoUrl = pdfUrl || werkNlSearchUrl(b.n);

      const card = document.createElement('div');
      card.className = 'card bg-white rounded-2xl p-5 shadow-sm border border-slate-100 flex flex-col justify-between';

      card.innerHTML = `
        <div>
          <div class="flex justify-between items-start gap-2 mb-2">
            <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400 leading-tight">${esc(b.s)}</span>
            <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase flex-shrink-0 ${lvlBadge(b.lvl)}">${lvlLabel(b.lvl)}</span>
          </div>

          <h3 class="text-base font-bold mb-3 leading-snug" style="color:var(--blue)">${esc(b.n)}</h3>

          <label class="flex items-center gap-2 cursor-pointer mb-3 group">
            <input data-k="${esc(k)}" data-f="like" type="checkbox"
                   class="w-4 h-4 rounded cursor-pointer" style="accent-color:var(--orange);"
                   ${entry.like ? 'checked' : ''}>
            <span class="text-sm font-semibold text-slate-700 group-hover:text-orange-600 transition-colors">Aangevinkt</span>
          </label>

          <label class="flex items-center gap-2 cursor-pointer mb-4">
            <input data-k="${esc(k)}" data-f="doelgroep" type="checkbox"
                   class="w-4 h-4 rounded cursor-pointer" style="accent-color:var(--mid);"
                   ${entry.doelgroep ? 'checked' : ''}>
            <span class="text-sm text-slate-500">Doelgroep-registratie</span>
          </label>
        </div>

        <div class="space-y-2.5">
          <textarea data-k="${esc(k)}" data-f="note"
            placeholder="Notities: wat trekt me aan? Wat houdt me tegen?"
            class="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-xs text-slate-700 leading-relaxed">${esc(entry.note||'')}</textarea>

          <a href="${esc(infoUrl)}" target="_blank" rel="noopener"
             class="inline-flex items-center gap-1 text-xs font-semibold hover:underline"
             style="color:var(--mid);">
            ℹ Meer info op Werk.nl
          </a>
        </div>
      `;

      container.appendChild(card);
    });

    // Events
    container.querySelectorAll('input[type=checkbox]').forEach(cb => {
      cb.addEventListener('change', e => {
        const k = e.target.dataset.k, f = e.target.dataset.f;
        userState[k] = userState[k] || { like:false, doelgroep:false, note:'' };
        userState[k][f] = e.target.checked;
        saveUserState();
        if (document.getElementById('selectedFilter').value === 'selected') filterContent();
      });
    });
    container.querySelectorAll('textarea').forEach(ta => {
      ta.addEventListener('input', e => {
        const k = e.target.dataset.k, f = e.target.dataset.f;
        userState[k] = userState[k] || { like:false, doelgroep:false, note:'' };
        userState[k][f] = e.target.value;
        saveUserState();
      });
    });
  }

  // =====================================================================
  // PDF PARSER (met echte werk.nl detail-links via annotaties)
  // =====================================================================
  const SECTORS_LIST = [
    "Bouw","Installatie","Voertuigentechniek","Industrie",
    "Transport - logistiek","Veiligheid","Detailhandel","Horeca",
    "Landbouw, natuur en milieu","Schoonmaak - reiniging",
    "Commercieel \u2013 HR - strategie","Financieel en administratie \u2013 juridisch",
    "ICT","Overheid","Onderwijs - pedagogisch","Zorg"
  ];

  function normalizeSector(t) {
    return t.replace(/\s*-\s*/g,' - ').replace(/\s*\u2013\s*/g,' \u2013 ').replace(/\s+/g,' ').trim();
  }

  function findSectors(text) {
    const norm = normalizeSector(text);
    for (const s of SECTORS_LIST) {
      if (norm === s) return s;
      if (norm.includes(s) && norm.replace(s,'').trim().length <= 2) return s;
    }
    return null;
  }

  function detectLevel(text) {
    const t = (text||'').toLowerCase();
    if (t.includes('basisvakmanschap') && !t.includes('middelbaar')) return 'Basis';
    if (t.includes('middelbaar beroepsniveau')) return 'Middelbaar';
    if (t.includes('hoger / wetenschappelijk')) return 'Hoger';
    return null;
  }

  function cleanName(t) {
    // haal eind-cijfertjes weg (voetnootjes) + rare losse leestekens
    return (t||'')
      .replace(/[\s,]*\d+[\s,\d]*$/,'')
      .replace(/\s+/g,' ')
      .trim();
  }

  function isNoise(t) {
    const s = (t||'').trim();
    if (s.length < 5) return true;
    if (/^[\d\s,.\-–]+$/.test(s)) return true;
    // minimaal 4 letters
    const letters = (s.match(/[A-Za-zÀ-ÿ]/g)||[]).length;
    if (letters < 4) return true;
    // typisch “rommel” die je soms ziet bij pdf extract
    if (/^(,|\.|–|-)+$/.test(s)) return true;
    return false;
  }

  function isFooter(text) {
    const t = (text||'').toLowerCase().trim();
    if (!t) return true;
    if (t === 'home' || t === 'uwv' || t.startsWith('home ')) return true;
    if (/^kansrijke beroepen/i.test(t)) return true;
    return false;
  }

  function yKey(y){ return Math.round(y / 3) * 3; }

  function bestLinkForY(links, y, maxDy=8){
    let best = null;
    let bestDy = Infinity;
    for (const l of links) {
      const dy = Math.abs(l.y - y);
      if (dy <= maxDy && dy < bestDy) {
        bestDy = dy;
        best = l;
      }
    }
    return best ? best.url : '';
  }

  async function parsePdfFile(arrayBuffer) {
    if (!window.pdfjsLib) throw new Error('PDF.js niet geladen. Ververs de pagina.');
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const allBeroepen = [];

    for (let p = 1; p <= pdf.numPages; p++) {
      // Skip cover (p1), intro (p2), colofon (last)
      if (p === 1 || p === 2 || p === pdf.numPages) continue;

      const page    = await pdf.getPage(p);
      const content = await page.getTextContent();

      // Links (annotaties) ophalen: dit zijn de echte werk.nl detail-links uit de PDF
      let ann = [];
      try {
        const anns = await page.getAnnotations();
        ann = (anns || [])
          .filter(a => a && a.subtype === 'Link' && (a.url || (a.action && a.action.url)) && a.rect)
          .map(a => {
            const url = a.url || (a.action && a.action.url) || '';
            const r = a.rect;
            const y = yKey((r[1] + r[3]) / 2);
            return { url, y };
          })
          // alleen werk.nl links (netter)
          .filter(a => /^https?:\/\/www\.werk\.nl\//i.test(a.url));
      } catch {
        ann = [];
      }

      // Words met posities
      const items = (content.items || [])
        .filter(it => it.str && it.str.trim())
        .map(it => ({
          x: it.transform[4],
          y: it.transform[5],
          text: it.str.trim().replace(/\u00A0/g,' ')
        }));

      // Groepeer per regel (y)
      const rows = new Map();
      for (const it of items) {
        const ky = yKey(it.y);
        if (!rows.has(ky)) rows.set(ky, []);
        rows.get(ky).push(it);
      }

      // Maak regels (text + minX)
      const lines = [...rows.entries()]
        .sort((a,b) => b[0] - a[0]) // boven naar beneden
        .map(([ky, arr]) => {
          arr.sort((a,b) => a.x - b.x);
          const minX = arr[0]?.x ?? 0;
          const text = arr.map(w => w.text).join(' ').replace(/\s+/g,' ').trim();
          return { y: ky, minX, text };
        })
        // filter lege / footer rommel
        .filter(l => l.text && !isFooter(l.text));

      let sector = null;
      let level  = null;

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const text = line.text;

        // Sector
        if (!text.startsWith('▪')) {
          const sec = findSectors(text);
          if (sec) { sector = sec; level = null; continue; }

          const lvl = detectLevel(text);
          if (lvl) { level = lvl; continue; }
        }

        // Bullet = beroep
        if (text.startsWith('▪')) {
          const bulletMinX = line.minX;
          let bulletText = text.slice(1).trim();

          // Continuatieregel: alleen als volgende regel ingesprongen is én dichtbij staat
          if (i + 1 < lines.length) {
            const next = lines[i+1];
            const gapY = Math.abs(line.y - next.y);

            const nextIsHeader = !!findSectors(next.text) || !!detectLevel(next.text);
            const nextIsBullet = next.text.startsWith('▪');

            const looksIndented = (next.minX > bulletMinX + 10); // echte wrap is meestal ingesprongen
            const looksClose = gapY <= 18;

            if (!nextIsHeader && !nextIsBullet && looksIndented && looksClose) {
              bulletText = (bulletText + ' ' + next.text).replace(/\s+/g,' ').trim();
              i++; // we hebben next verbruikt
            }
          }

          const name = cleanName(bulletText);
          if (!isNoise(name) && sector && level) {
            const url = bestLinkForY(ann, line.y, 8); // echte link bij dit bullet punt
            allBeroepen.push({
              s: sector,
              n: name,
              lvl: level,
              info: 'Uit UWV-lijst kansrijke beroepen',
              url: url || ''
            });
          }
        }
      }
    }

    // Dedup
    const seen = new Set();
    return allBeroepen.filter(b => {
      const k = getKey(b);
      if (seen.has(k)) return false;
      seen.add(k);
      return true;
    });
  }

  // =====================================================================
  // INSTELLINGEN ACTIES
  // =====================================================================
  document.getElementById('pdfFileInput').addEventListener('change', async () => {
    const file = document.getElementById('pdfFileInput').files?.[0];
    if (!file) return;
    setMsg('⏳ PDF wordt gelezen…', 'slate');
    try {
      const bytes   = await file.arrayBuffer();
      const parsed  = await parsePdfFile(bytes);
      if (!parsed.length) { setMsg('❌ Geen beroepen gevonden. Probeer de officiële UWV PDF.', 'red'); return; }
      saveData(parsed);
      refreshSectorDropdown();
      filterContent();
      setMsg(`✅ Klaar! ${parsed.length} beroepen ingeladen (met echte “Meer info” links).`, 'green');
      showPortal();
    } catch(e) {
      setMsg(`❌ Fout: ${e.message}`, 'red');
    }
  });

  function loadDefault() {
    saveData(INGEBOUWDE_DATA);
    refreshSectorDropdown();
    filterContent();
    setMsg('✅ Standaard data 2025–2026 geladen. (Links zijn dan zoeklinks.)', 'green');
    showPortal();
  }

  function clearUserState() {
    localStorage.removeItem(STORAGE_STATE);
    userState = {};
    setMsg('✅ Jouw notities en vinkjes zijn gewist.', 'green');
    filterContent();
  }

  function setMsg(msg, color) {
    const colors = { green:'text-emerald-700', red:'text-red-600', slate:'text-slate-600' };
    document.getElementById('settingsMsg').innerHTML =
      `<span class="font-semibold ${colors[color]||'text-slate-600'}">${esc(msg)}</span>`;
  }

  // =====================================================================
  // EXPORT (print)
  // =====================================================================
  document.getElementById('exportBtn').addEventListener('click', () => {
    // Zet de gewenste afdruk-stand klaar
    applyPrintOrientation(document.getElementById('printOrientation').value);

    buildExport();
    window.print();
  });

  function applyPrintOrientation(mode){
    const el = document.getElementById('printPageStyle');
    const size = (mode === 'landscape') ? 'A4 landscape' : 'A4 portrait';
    el.textContent = `
      @media print {
        @page { size: ${size}; margin: 12mm; }
      }
    `;
  }

  function buildExport() {
    // ALLEEN "Aangevinkt" (= Past bij mij) exporteren
    const selected = beroepen
      .map(b => ({ b, entry: getEntry(b) }))
      .filter(x => x.entry.like);

    const exportList = document.getElementById('exportList');
    exportList.innerHTML = '';

    const now = new Date();
    document.getElementById('exportMeta').textContent =
      `Aangemaakt: ${now.toLocaleString('nl-NL')}`;

    document.getElementById('exportSubtitle').textContent =
      selected.length
        ? `${selected.length} beroep${selected.length !== 1 ? 'en' : ''} geselecteerd`
        : 'Geen beroepen geselecteerd';

    if (!selected.length) {
      exportList.innerHTML = `
        <div class="p-5 border rounded-xl bg-slate-50 text-slate-600 text-sm">
          Je hebt nog geen beroepen aangevinkt. Ga naar het portaal en vink beroepen aan via “Aangevinkt”.
        </div>`;
      return;
    }

    // Group by sector
    const groups = {};
    for (const item of selected) {
      const s = item.b.s || 'Overig';
      if (!groups[s]) groups[s] = [];
      groups[s].push(item);
    }

    const lvlOrder = { Basis:0, Middelbaar:1, Hoger:2 };

    for (const sector of Object.keys(groups).sort((a,b) => a.localeCompare(b,'nl'))) {
      const items = groups[sector].sort((a,b) =>
        (lvlOrder[a.b.lvl]||9) - (lvlOrder[b.b.lvl]||9) ||
        (a.b.n||'').localeCompare((b.b.n||''),'nl')
      );

      const block = document.createElement('div');
      block.className = 'export-card rounded-2xl overflow-hidden';

      const header = document.createElement('div');
      header.className = 'export-sector-header px-5 py-3 border-b border-slate-200';
      header.innerHTML = `<div class="font-bold text-sm uppercase tracking-wider" style="color:var(--blue)">${esc(sector)}</div>`;
      block.appendChild(header);

      const body = document.createElement('div');
      body.className = 'divide-y divide-slate-100';

      for (const { b, entry } of items) {
        const row = document.createElement('div');
        row.className = 'px-5 py-4';

        const note = (entry.note || '').trim();
        const badgeCls = lvlBadge(b.lvl);
        const badgeLbl = lvlLabel(b.lvl);

        const doelgroepTxt = entry.doelgroep ? 'Ja' : 'Nee';

        row.innerHTML = `
          <div class="flex items-start justify-between gap-3 mb-1">
            <div class="font-semibold text-sm leading-snug" style="color:var(--blue)">${esc(b.n)}</div>
            <span class="px-2 py-0.5 rounded text-[10px] font-bold flex-shrink-0 export-lvl-badge ${badgeCls}">${badgeLbl}</span>
          </div>

          <div class="text-xs text-slate-500 mt-1">
            Doelgroep-registratie: <span class="font-semibold text-slate-700">${doelgroepTxt}</span>
          </div>

          ${note
            ? `<div class="text-sm text-slate-700 leading-relaxed mt-2 bg-slate-50 rounded-lg p-3">${esc(note)}</div>`
            : `<div class="text-xs text-slate-400 mt-2 italic">Geen notities ingevuld.</div>`
          }
        `;
        body.appendChild(row);
      }

      block.appendChild(body);
      exportList.appendChild(block);
    }
  }

  // =====================================================================
  // INIT
  // =====================================================================
  function init() {
    showPortal();
    updateBadge();
    refreshSectorDropdown();
    render();
  }

  window.addEventListener('load', () => {
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  });
  </script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>init();</script>

</body>
</html>

