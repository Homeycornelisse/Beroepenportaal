<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Beroepen Portaal 2026</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- PDF.js v3 (stabiel met pdfjsLib) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: { brand: { blue: '#1e3a8a', orange: '#f97316', bg: '#f1f5f9' } }
        }
      }
    };
  </script>

  <style>
    .glass { background: rgba(255,255,255,.9); backdrop-filter: blur(10px); }
    textarea { resize: none; min-height: 80px; border: 1px solid #cbd5e1; }
    textarea:focus { border-color: #f97316; outline: none; box-shadow: 0 0 0 2px rgba(249,115,22,.2); }

    @media print {
      .no-print { display:none !important; }
      #exportView { display:block !important; }
      body { background: white !important; }
    }
  </style>
</head>

<body class="bg-brand-bg text-slate-900 font-sans leading-relaxed">

  <!-- NAV -->
  <nav class="glass sticky top-0 z-50 border-b border-slate-200 no-print">
    <div class="container mx-auto px-6 py-4 flex flex-wrap gap-3 justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="bg-brand-blue p-2 rounded-lg text-white font-bold text-xl">BP</div>
        <h1 class="text-xl font-bold tracking-tight">Mijn Beroepen Portaal 2026</h1>
        <span id="dataBadge" class="text-xs font-semibold text-slate-500"></span>
      </div>

      <div class="flex flex-wrap gap-3 items-center">
        <button id="tabPortalBtn" class="px-3 py-2 rounded-lg font-bold bg-brand-blue text-white hover:opacity-90">Portaal</button>
        <button id="tabSettingsBtn" class="px-3 py-2 rounded-lg font-bold bg-white border hover:bg-slate-50">Instellingen</button>

        <input type="text" id="searchInput" placeholder="Zoek beroep of sector..." class="p-2 border rounded-lg text-sm w-64">

        <button id="exportBtn" class="bg-brand-orange text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-orange-600 transition">
          Export PDF (Past bij mij)
        </button>
      </div>
    </div>
  </nav>

  <main class="container mx-auto px-4 py-8 max-w-7xl">

    <!-- PORTAAL -->
    <section id="portalView">
      <section class="mb-6 flex flex-wrap gap-3 no-print">
        <select id="sectorFilter" class="p-3 bg-white border rounded-xl text-sm font-semibold shadow-sm">
          <option value="all">Alle sectoren</option>
        </select>

        <select id="levelFilter" class="p-3 bg-white border rounded-xl text-sm font-semibold shadow-sm">
          <option value="all">Alle niveaus</option>
          <option value="Basis">Basisvakmanschap</option>
          <option value="Middelbaar">Middelbaar</option>
          <option value="Hoger">Hoger</option>
        </select>

        <select id="selectedFilter" class="p-3 bg-white border rounded-xl text-sm font-semibold shadow-sm">
          <option value="all">Alles</option>
          <option value="selected">Alleen “Past bij mij”</option>
        </select>

        <button id="resetBtn" class="px-4 py-3 rounded-xl bg-white border font-semibold hover:bg-slate-50">
          Filters leegmaken
        </button>

        <div id="statusLine" class="text-sm text-slate-600 flex items-center"></div>
      </section>

      <div id="beroepenContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
    </section>

    <!-- INSTELLINGEN -->
    <section id="settingsView" class="hidden no-print">
      <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 max-w-2xl">
        <h2 class="text-xl font-bold text-brand-blue mb-2">Instellingen</h2>
        <p class="text-sm text-slate-600 mb-4">
          Upload de UWV PDF. Daarna vult het portaal zichzelf.
        </p>

        <div class="mt-2">
          <label class="text-sm font-semibold text-slate-700">PDF uploaden</label>
          <input id="pdfFileInput" type="file" accept="application/pdf"
                 class="mt-2 w-full p-3 border rounded-xl text-sm bg-white">
          <p class="text-xs text-slate-500 mt-2">
            Werkt ook op GitHub Pages. (PDF-link inladen is vaak geblokkeerd.)
          </p>
        </div>

        <div class="flex flex-wrap gap-3 mt-5">
          <button id="useDemoBtn" class="bg-white border px-4 py-2 rounded-lg font-bold hover:bg-slate-50">
            Gebruik demo-data
          </button>
          <button id="clearNotesBtn" class="bg-white border px-4 py-2 rounded-lg font-bold hover:bg-slate-50">
            Mijn notities/keuzes wissen
          </button>
        </div>

        <div id="settingsMsg" class="mt-4 text-sm text-slate-700"></div>
      </div>
    </section>

    <!-- EXPORT VIEW (alleen zichtbaar bij print) -->
    <section id="exportView" class="hidden">
      <div class="bg-white p-6">
        <div class="flex items-baseline justify-between gap-4">
          <h2 class="text-2xl font-bold text-brand-blue">Export: Past bij mij</h2>
          <div class="text-sm text-slate-600" id="exportMeta"></div>
        </div>

        <div class="mt-4 text-sm text-slate-700">
          Alleen beroepen waar jij “Past bij mij” hebt aangevinkt. Opmerkingen worden meegenomen.
        </div>

        <div id="exportList" class="mt-6 space-y-4"></div>
      </div>
    </section>

  </main>

  <script>
    // ========= PDF.js worker =========
    window.addEventListener("load", () => {
      if (window.pdfjsLib) {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      }
    });

    // ========= OPSLAG =========
    const STORAGE_KEY = "bp2026_data_v4";
    const STORAGE_USER_STATE = "bp2026_user_state_v4";

    const demoBeroepen = [
      { s: "Bouw", n: "Timmerlieden (onderhoud en civiele bouw)", lvl: "Middelbaar", info: "Demo", url: "" },
      { s: "ICT", n: "Softwareontwikkelaars", lvl: "Hoger", info: "Demo", url: "" },
      { s: "Zorg", n: "Doktersassistenten", lvl: "Middelbaar", info: "Demo", url: "" },
    ];

    let beroepen = loadData() || demoBeroepen;
    let userState = loadUserState();

    function saveData(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        savedAt: new Date().toISOString(),
        beroepen: data
      }));
      beroepen = data;
      updateBadge();
    }

    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        return obj?.beroepen || null;
      } catch { return null; }
    }

    function updateBadge() {
      const badge = document.getElementById("dataBadge");
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) { badge.textContent = ""; return; }
        const obj = JSON.parse(raw);
        const dt = obj?.savedAt ? new Date(obj.savedAt) : null;
        badge.textContent = dt ? `• Laatst bijgewerkt: ${dt.toLocaleString("nl-NL")}` : "";
      } catch { badge.textContent = ""; }
    }

    function loadUserState() {
      try {
        const raw = localStorage.getItem(STORAGE_USER_STATE);
        if (!raw) return {};
        return JSON.parse(raw) || {};
      } catch { return {}; }
    }

    function saveUserState() {
      localStorage.setItem(STORAGE_USER_STATE, JSON.stringify(userState));
    }

    function setStatus(msg) {
      document.getElementById("statusLine").textContent = msg || "";
    }

    function escapeHtml(str) {
      return (str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalizeName(x) {
      return (x || "").replace(/\u00A0/g, " ").replace(/\s+/g, " ").trim();
    }

    function keyForBeroep(b) {
      return `${b.s}||${b.n}`.toLowerCase();
    }

    function getUserEntry(b) {
      const k = keyForBeroep(b);
      if (!userState[k]) userState[k] = { like: false, doelgroep: false, note: "" };
      return userState[k];
    }

    function isPastBijMij(entry) {
      return !!(entry?.like);
    }

    // ========= TABS =========
    const portalView = document.getElementById("portalView");
    const settingsView = document.getElementById("settingsView");
    document.getElementById("tabPortalBtn").addEventListener("click", () => showPortal());
    document.getElementById("tabSettingsBtn").addEventListener("click", () => showSettings());

    function showPortal() {
      portalView.classList.remove("hidden");
      settingsView.classList.add("hidden");
      document.getElementById("tabPortalBtn").className = "px-3 py-2 rounded-lg font-bold bg-brand-blue text-white hover:opacity-90";
      document.getElementById("tabSettingsBtn").className = "px-3 py-2 rounded-lg font-bold bg-white border hover:bg-slate-50";
    }
    function showSettings() {
      settingsView.classList.remove("hidden");
      portalView.classList.add("hidden");
      document.getElementById("tabSettingsBtn").className = "px-3 py-2 rounded-lg font-bold bg-brand-blue text-white hover:opacity-90";
      document.getElementById("tabPortalBtn").className = "px-3 py-2 rounded-lg font-bold bg-white border hover:bg-slate-50";
    }

    // ========= FILTERS =========
    const searchInput = document.getElementById("searchInput");
    const levelFilter = document.getElementById("levelFilter");
    const sectorFilter = document.getElementById("sectorFilter");
    const selectedFilter = document.getElementById("selectedFilter");
    const resetBtn = document.getElementById("resetBtn");

    searchInput.addEventListener("keyup", filterContent);
    levelFilter.addEventListener("change", filterContent);
    sectorFilter.addEventListener("change", filterContent);
    selectedFilter.addEventListener("change", filterContent);

    resetBtn.addEventListener("click", () => {
      searchInput.value = "";
      levelFilter.value = "all";
      sectorFilter.value = "all";
      selectedFilter.value = "all";
      filterContent();
    });

    function refreshSectorDropdown() {
      const sectors = [...new Set(beroepen.map(b => b.s))].sort((a,b)=>a.localeCompare(b,'nl'));
      sectorFilter.innerHTML =
        `<option value="all">Alle sectoren</option>` +
        sectors.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
    }

    function filterContent() {
      const query = (searchInput.value || "").toLowerCase();
      const level = levelFilter.value;
      const sector = sectorFilter.value;
      const onlySel = selectedFilter.value === "selected";
      render(query, level, sector, onlySel);
    }

    // ========= WERK.NL LINKS =========
    // 1) Als PDF een echte link heeft, gebruiken we die: b.url
    // 2) Anders fallback: zoekpagina (werkt altijd)
    function werkNlFallbackZoekUrl(beroepNaam) {
      return `https://www.werk.nl/werkzoekenden/beroepen-en-opleidingen/beroepen/zoeken?zoekterm=${encodeURIComponent(beroepNaam)}`;
    }

    // ========= RENDER =========
    function render(filter = "", level = "all", sector = "all", onlySelected = false) {
      const container = document.getElementById("beroepenContainer");
      container.innerHTML = "";

      const filtered = beroepen.filter(b => {
        const entry = getUserEntry(b);

        const matchQuery =
          (b.n || "").toLowerCase().includes(filter) ||
          (b.s || "").toLowerCase().includes(filter) ||
          (b.info || "").toLowerCase().includes(filter);

        const matchLevel = level === "all" || (b.lvl || "").includes(level);
        const matchSector = sector === "all" || b.s === sector;
        const matchSelected = !onlySelected || isPastBijMij(entry);

        return matchQuery && matchLevel && matchSector && matchSelected;
      });

      setStatus(`Resultaat: ${filtered.length} van ${beroepen.length} beroepen`);

      filtered.forEach(b => {
        const entry = getUserEntry(b);

        const lvlBadgeClass = (b.lvl || "").includes("Hoger")
          ? "bg-blue-100 text-blue-700"
          : ((b.lvl || "").includes("Basis") ? "bg-slate-100 text-slate-700" : "bg-green-100 text-green-700");

        const infoUrl = (b.url && b.url.startsWith("http")) ? b.url : werkNlFallbackZoekUrl(b.n);

        const card = document.createElement("div");
        card.className = "bg-white rounded-2xl p-6 shadow-sm border border-slate-200 flex flex-col justify-between";

        card.innerHTML = `
          <div>
            <div class="flex justify-between items-start mb-2 gap-2">
              <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400">${escapeHtml(b.s)}</span>
              <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${lvlBadgeClass}">
                ${escapeHtml(b.lvl || "")}
              </span>
            </div>

            <h3 class="text-lg font-bold text-brand-blue mb-1">${escapeHtml(b.n)}</h3>
            <p class="text-[11px] text-slate-500 mb-4">${escapeHtml(b.info || "")}</p>

            <div class="grid grid-cols-2 gap-4 mb-4 border-t border-b border-slate-50 py-3">
              <label class="flex items-center gap-2 cursor-pointer">
                <input data-k="${escapeHtml(keyForBeroep(b))}" data-field="like" type="checkbox" class="w-4 h-4 accent-brand-orange" ${entry.like ? "checked" : ""}>
                <span class="text-xs font-semibold">Past bij mij</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer opacity-70">
                <input data-k="${escapeHtml(keyForBeroep(b))}" data-field="doelgroep" type="checkbox" class="w-4 h-4 accent-brand-blue" ${entry.doelgroep ? "checked" : ""}>
                <span class="text-xs font-semibold">Doelgroep-reg.</span>
              </label>
            </div>
          </div>

          <div class="space-y-3">
            <textarea data-k="${escapeHtml(keyForBeroep(b))}" data-field="note"
              placeholder="Mijn tegels: Wat is het gedoe? Wat houdt me tegen?"
              class="w-full bg-slate-50 rounded-xl p-3 text-xs">${escapeHtml(entry.note || "")}</textarea>

            <div class="flex flex-wrap gap-2 items-center">
              <a href="${infoUrl}" target="_blank" rel="noopener"
                 class="text-[10px] font-bold text-brand-blue hover:text-brand-orange flex items-center gap-1">
                ℹ️ Meer info (Werk.nl)
              </a>
              ${b.url ? `<span class="text-[10px] text-slate-500">• link uit PDF</span>` : `<span class="text-[10px] text-slate-500">• zoeklink</span>`}
            </div>
          </div>
        `;

        container.appendChild(card);
      });

      // checkboxen opslaan
      container.querySelectorAll("input[type=checkbox]").forEach(cb => {
        cb.addEventListener("change", (e) => {
          const k = e.target.getAttribute("data-k");
          const field = e.target.getAttribute("data-field");
          userState[k] = userState[k] || { like:false, doelgroep:false, note:"" };
          userState[k][field] = e.target.checked;
          saveUserState();
          if (selectedFilter.value === "selected") filterContent();
        });
      });

      // notities opslaan
      container.querySelectorAll("textarea").forEach(ta => {
        ta.addEventListener("input", (e) => {
          const k = e.target.getAttribute("data-k");
          const field = e.target.getAttribute("data-field");
          userState[k] = userState[k] || { like:false, doelgroep:false, note:"" };
          userState[k][field] = e.target.value;
          saveUserState();
        });
      });
    }

    // ========= PDF INLEZEN (UPLOAD) =========
    const settingsMsg = document.getElementById("settingsMsg");
    const pdfFileInput = document.getElementById("pdfFileInput");
    const useDemoBtn = document.getElementById("useDemoBtn");
    const clearNotesBtn = document.getElementById("clearNotesBtn");

    function setSettingsMsg(msg, ok=true) {
      settingsMsg.innerHTML = `<span class="${ok ? "text-emerald-700" : "text-rose-700"} font-semibold">${escapeHtml(msg)}</span>`;
    }

    function ensurePdfLib() {
      if (!window.pdfjsLib) throw new Error("PDF-lezer is niet geladen. Ververs de pagina en probeer opnieuw.");
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    }

    // Sectoren komen letterlijk voor in de PDF (kopjes) :contentReference[oaicite:1]{index=1}
    const SECTORS = new Set([
      "Bouw",
      "Installatie",
      "Voertuigentechniek",
      "Industrie",
      "Transport - logistiek",
      "Veiligheid",
      "Detailhandel",
      "Horeca",
      "Landbouw, natuur en milieu",
      "Schoonmaak - reiniging",
      "Commercieel – HR - strategie",
      "Financieel en administratie – juridisch",
      "ICT",
      "Overheid",
      "Onderwijs - pedagogisch",
      "Zorg"
    ]);

    function isLevelLine(lineLower) {
      if (lineLower.includes("basisvakmanschap")) return "Basis";
      if (lineLower.includes("middelbaar beroepsniveau")) return "Middelbaar";
      if (lineLower.includes("hoger / wetenschappelijk")) return "Hoger";
      return null;
    }

    function cleanBulletName(raw) {
      let t = normalizeName(raw);
      t = t.replace(/^([▪•\-–])\s*/g, "").trim();
      t = t.replace(/\s*[0-9]+(\s*,\s*[0-9]+)*\s*$/, "").trim(); // voetnoten/eindcijfers weg
      return t;
    }

    function looksLikeNoise(name) {
      const t = (name || "").trim();
      const lower = t.toLowerCase();
      if (t.length < 4) return true;
      if (/^[0-9\s,.\-–]+$/.test(t)) return true;
      if (SECTORS.has(t)) return true;
      if (lower.includes("uwv")) return true;
      if (lower.includes("kansrijke beroepen")) return true;
      if (lower.includes("algemeen")) return true;
      if (lower.includes("colofon")) return true;
      if (lower === "midden" || lower === "weg") return true;
      // genoeg letters?
      const letters = (t.match(/[A-Za-zÀ-ÿ]/g) || []).length;
      if (letters < 4) return true;
      return false;
    }

    // Leest per pagina:
    // - Tekstitems => netjes per regel (y-groepering)
    // - Link-annotaties => URL per regel (als het info-icoon klikbaar is)
    async function extractRowsWithLinks(arrayBuffer) {
      ensurePdfLib();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      const allRows = [];

      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);

        const [content, annotations] = await Promise.all([
          page.getTextContent(),
          page.getAnnotations({ intent: "display" })
        ]);

        // alleen echte url-links pakken
        const linkAnn = (annotations || [])
          .filter(a => a && (a.url || a.unsafeUrl) && a.subtype === "Link")
          .map(a => ({
            url: a.url || a.unsafeUrl,
            rect: a.rect // [x1,y1,x2,y2] in PDF coords
          }));

        // tekst groeperen per yKey
        const rows = new Map();
        for (const it of (content.items || [])) {
          const str = (it.str || "").trim();
          if (!str) continue;

          const x = it.transform?.[4] ?? 0;
          const y = it.transform?.[5] ?? 0;
          const yKey = Math.round(y); // afronden zodat woorden op 1 regel samen komen

          if (!rows.has(yKey)) rows.set(yKey, []);
          rows.get(yKey).push({ x, y, str });
        }

        // van boven naar beneden
        const yKeys = Array.from(rows.keys()).sort((a, b) => b - a);

        for (const yKey of yKeys) {
          const parts = rows.get(yKey).sort((a, b) => a.x - b.x).map(o => o.str);
          const line = normalizeName(parts.join(" "));

          if (!line) continue;

          // URL zoeken die "op dezelfde regel" zit:
          // PDF coords: yKey komt redelijk overeen met rect y (we pakken overlap)
          let url = "";
          for (const a of linkAnn) {
            const y1 = Math.min(a.rect[1], a.rect[3]);
            const y2 = Math.max(a.rect[1], a.rect[3]);
            // beetje speling
            if (yKey >= (y1 - 3) && yKey <= (y2 + 3)) {
              url = a.url;
              break;
            }
          }

          allRows.push({ line, url });
        }
      }

      return allRows;
    }

    function parseBeroepenFromRows(rows) {
      let currentSector = null;
      let currentLevel = null;

      const out = [];

      for (const r of rows) {
        const line = (r.line || "").trim();
        const lower = line.toLowerCase();

        // sector exact herkennen
        if (SECTORS.has(line)) {
          currentSector = line;
          continue;
        }

        // niveau herkennen
        const lvl = isLevelLine(lower);
        if (lvl) {
          currentLevel = lvl;
          continue;
        }

        // alleen bulletregels als beroep (dit voorkomt rommel)
        const isBullet = /^([▪•\-–])\s+/.test(line);
        if (!isBullet) continue;
        if (!currentSector || !currentLevel) continue;

        const name = cleanBulletName(line);
        if (looksLikeNoise(name)) continue;

        out.push({
          s: currentSector,
          n: name,
          lvl: currentLevel,
          info: "Uit UWV-lijst kansrijke beroepen",
          url: (r.url && r.url.startsWith("http")) ? r.url : ""
        });
      }

      // dubbelen eruit (en als er 2 entries zijn, bewaar die met url)
      const map = new Map();
      for (const b of out) {
        const k = `${b.s}||${b.n}`.toLowerCase();
        if (!map.has(k)) map.set(k, b);
        else {
          const existing = map.get(k);
          if (!existing.url && b.url) map.set(k, b);
        }
      }

      const unique = Array.from(map.values());

      const lvlOrder = { "Basis": 1, "Middelbaar": 2, "Hoger": 3 };
      unique.sort((a,b) => {
        const s = a.s.localeCompare(b.s, "nl");
        if (s !== 0) return s;
        const l = (lvlOrder[a.lvl] || 9) - (lvlOrder[b.lvl] || 9);
        if (l !== 0) return l;
        return a.n.localeCompare(b.n, "nl");
      });

      return unique;
    }

    pdfFileInput.addEventListener("change", async () => {
      const file = pdfFileInput.files?.[0];
      if (!file) return;

      setSettingsMsg("Bezig met PDF inlezen…", true);

      try {
        const bytes = await file.arrayBuffer();
        const rows = await extractRowsWithLinks(bytes);
        const parsed = parseBeroepenFromRows(rows);

        if (!parsed.length) {
          setSettingsMsg("Ik kon geen beroepen vinden. Probeer een andere PDF-versie of stuur me een screenshot van 1 pagina.", false);
          return;
        }

        saveData(parsed);
        refreshSectorDropdown();
        filterContent();

        const withLinks = parsed.filter(b => b.url).length;
        setSettingsMsg(`Klaar! ${parsed.length} beroepen ingeladen. Linkjes uit PDF gevonden: ${withLinks}.`, true);
        showPortal();
      } catch (e) {
        setSettingsMsg(`Mislukt: ${e.message}`, false);
      }
    });

    useDemoBtn.addEventListener("click", () => {
      saveData(demoBeroepen);
      refreshSectorDropdown();
      filterContent();
      setSettingsMsg("Demo-data staat aan.", true);
      showPortal();
    });

    clearNotesBtn.addEventListener("click", () => {
      localStorage.removeItem(STORAGE_USER_STATE);
      userState = {};
      setSettingsMsg("Alles gewist: je notities en vinkjes zijn verwijderd.", true);
      filterContent();
    });

    // ========= EXPORT “PAST BIJ MIJ” =========
    const exportBtn = document.getElementById("exportBtn");
    const exportList = document.getElementById("exportList");
    const exportMeta = document.getElementById("exportMeta");

    function buildExport() {
      const selected = beroepen
        .map(b => ({ b, entry: getUserEntry(b) }))
        .filter(x => x.entry && x.entry.like === true); // alleen Past bij mij

      exportList.innerHTML = "";

      const now = new Date();
      exportMeta.textContent = `Gemaakt op: ${now.toLocaleString("nl-NL")} • Aantal: ${selected.length}`;

      if (!selected.length) {
        exportList.innerHTML = `
          <div class="p-4 border rounded-xl bg-slate-50">
            <div class="font-bold text-slate-800">Geen selectie</div>
            <div class="text-slate-600 text-sm mt-1">Vink bij een beroep “Past bij mij” aan en probeer opnieuw.</div>
          </div>
        `;
        return;
      }

      // groeperen op sector
      const groups = {};
      for (const item of selected) {
        const s = item.b.s || "Overig";
        if (!groups[s]) groups[s] = [];
        groups[s].push(item);
      }

      const sectorNames = Object.keys(groups).sort((a,b)=>a.localeCompare(b,"nl"));

      for (const sector of sectorNames) {
        const block = document.createElement("div");
        block.className = "border rounded-2xl p-4";

        block.innerHTML = `
          <div class="text-sm font-bold text-slate-600 uppercase tracking-wider">${escapeHtml(sector)}</div>
          <div class="mt-3 space-y-3"></div>
        `;

        const secDiv = block.querySelector("div.mt-3");

        groups[sector].forEach(({b, entry}) => {
          const note = (entry.note || "").trim();
          const row = document.createElement("div");
          row.className = "p-3 rounded-xl bg-slate-50 border";

          row.innerHTML = `
            <div class="flex flex-wrap items-center justify-between gap-2">
              <div class="font-bold text-brand-blue">${escapeHtml(b.n)}</div>
              <div class="text-xs font-semibold text-slate-600">${escapeHtml(b.lvl || "")}</div>
            </div>
            <div class="mt-2 text-sm text-slate-800">
              ${note ? escapeHtml(note) : `<span class="text-slate-500">Geen opmerkingen ingevuld.</span>`}
            </div>
          `;

          secDiv.appendChild(row);
        });

        exportList.appendChild(block);
      }
    }

    exportBtn.addEventListener("click", () => {
      buildExport();
      window.print();
    });

    // ========= START =========
    function init() {
      updateBadge();
      refreshSectorDropdown();
      render();
      setStatus(`Data geladen: ${beroepen.length} beroepen`);
    }

    init();
  </script>

</body>
</html>
